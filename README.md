# PDF Direction Corrector

🔄 **PDF ファイルの回転を自動検出・修正するツール**

回転してしまった PDF ファイルを、テキストの配置位置を分析して自動的に正しい向きに修正します。

## 📋 目次

- [概要](#概要)
- [2 つの検出方法](#2つの検出方法)
- [インストール](#インストール)
- [使用方法](#使用方法)
- [技術的な仕組み](#技術的な仕組み)
- [サポートファイル形式](#サポートファイル形式)

## 📖 概要

PDF ファイルが 90 度、180 度、270 度回転してしまった場合、このツールが**テキストの実際の配置位置**を分析して、正しい向きに自動修正します。

### ✨ 特徴

- 🤖 **完全自動**: ファイル名や手動設定に依存せず、PDF 内容のみで判定
- 🎯 **高精度**: 実際のテキスト座標を数学的に分析
- 🌐 **多言語対応**: 日本語、英語、その他の言語で動作
- ⚡ **高速処理**: PyMuPDF による効率的な PDF 解析
- 🔄 **2 つの検出方式**: 絶対位置ベースと相対位置ベースから選択可能

## 🎯 2 つの検出方法

### 方法 1️⃣: **絶対位置ベース**（単体動作）

**仕組み**: OCR 化された PDF から「最初の文字」の絶対座標を取得し、一般的な文書レイアウトと比較

```
(0,0) ────────────────── (595,0)
  │                         │
  │    (100,85) ← 最初の文字  │
  │      ┌─────┐           │  ← A4サイズ
  │      │テキスト│           │    595 x 842ポイント
  │      └─────┘           │
  │                         │
(0,842) ──────────────── (595,842)
```

**判定ロジック**:

- **左上エリア** (x<0.4, y<0.4) → 正常 (0 度)
- **右下エリア** (x>0.6, y>0.6) → 180 度回転
- **左下エリア** (x<0.4, y>0.6) → 90 度左回転
- **右上エリア** (x>0.6, y<0.4) → 90 度右回転

**メリット**: 基準ファイル不要、どんな PDF でも単独動作  
**デメリット**: 複雑なレイアウトで精度低下の可能性

### 方法 2️⃣: **相対位置ベース**（基準ファイルとの比較）

**仕組み**: 正常な PDF ファイルを「基準」として、他の PDF がその基準とどれだけ一致するかをスコア計算

```
基準ファイル(normal.pdf): テキスト位置 A, B, C, D

回転テスト:
├── 0度回転:   スコア 0.000 ← 基準と全然違う
├── 90度回転:  スコア 0.808 ← 高い一致度！✅
├── 180度回転: スコア 0.187
└── 270度回転: スコア 0.000

→ 90度回転が最適と判定し、-90度修正を適用
```

**メリット**: 高精度、複雑なレイアウトに対応  
**デメリット**: 正常な基準ファイルが 1 つ必要

## 🛠️ インストール

### 前提条件

- Python 3.8 以上
- uv (Python パッケージマネージャー)

### インストール手順

```bash
# 1. プロジェクトクローン
git clone <repository-url>
cd pdf-direction-corrector

# 2. uvプロジェクト初期化
uv init

# 3. 依存関係インストール
uv add PyMuPDF reportlab
```

## 🚀 使用方法

### 基本的な使い方

```bash
# プログラム実行
uv run python main.py
```

実行すると、検出方法選択メニューが表示されます：

```
🔄 回転検出方法を選択してください:
1. 絶対位置ベース（基準ファイル不要、単体動作）
2. 相対位置ベース（基準ファイルとの比較、高精度）
3. 自動選択（基準ファイルがあれば相対、なければ絶対）
```

### ファイル構成

実行前：

```
pdf-direction-corrector/
├── main.py
├── output/
│   ├── document1.pdf  ← 回転しているPDF
│   ├── document2.pdf  ← 回転しているPDF
│   └── normal.pdf     ← 正常なPDF（基準用）
```

実行後：

```
pdf-direction-corrector/
├── main.py
├── output/              ← 元のファイル
└── corrected/          ← 修正済みファイル
    ├── document1_corrected.pdf
    ├── document2_corrected.pdf
    └── normal_corrected.pdf
```

## 🔬 技術的な仕組み

### テキスト座標の取得

```python
# PyMuPDFでテキストの絶対座標を取得
text_dict = page.get_text("dict")
for span in line["spans"]:
    bbox = span["bbox"]  # [x0, y0, x1, y1] 絶対座標
    text = span["text"]  # 実際のテキスト内容
```

### 座標変換処理

回転された PDF の座標を「元の座標系」に変換：

```python
def transform_coordinates(bbox, page_width, page_height, rotation):
    x0, y0, x1, y1 = bbox

    if rotation == 90:   # 90度回転 → 元に戻す
        return [y0, page_width - x1, y1, page_width - x0]
    elif rotation == 180: # 180度回転 → 元に戻す
        return [page_width - x1, page_height - y1,
                page_width - x0, page_height - y0]
    elif rotation == 270: # 270度回転 → 元に戻す
        return [page_height - y1, x0, page_height - y0, x1]
    else:
        return [x0, y0, x1, y1]
```

### スコア計算（相対位置ベース）

```python
def calculate_similarity(positions1, positions2):
    total_score = 0
    for pos1 in positions1:
        # 最も近いテキストとの距離を計算
        min_distance = min([
            euclidean_distance(pos1, pos2)
            for pos2 in positions2
        ])
        # 距離を類似度スコアに変換
        score = max(0, 1 - min_distance * 2)
        total_score += score

    return total_score / len(positions1)
```

## 📄 サポートファイル形式

### ✅ サポート対象

- **OCR 済み PDF**: テキスト情報が埋め込まれている PDF
- **テキストベース PDF**: 元々テキストとして作成された PDF
- **多言語 PDF**: 日本語、英語、中国語など

### ❌ 非サポート

- **画像のみ PDF**: テキスト情報が含まれていない PDF
- **手書き文字**: OCR されていない手書き文字
- **複雑な表レイアウト**: 表が主体で通常テキストが少ない PDF

## 🎛️ 実行例

### 絶対位置ベース実行例

```
🔍 絶対位置ベースの詳細分析
📝 最初のテキスト: 'これは日本語のテスト'
   正規化座標: (0.168, 0.101)
📍 全テキスト正規化平均位置: (0.309, 0.184)
🎯 典型的な文書開始位置との比較:
   正常文書: 左上 (0.1-0.3, 0.1-0.4)  ← 一致！
   90度回転: 左下 (0.1-0.4, 0.6-0.9)
   180度回転: 右下 (0.6-0.9, 0.6-0.9)
   270度回転: 右上 (0.6-0.9, 0.1-0.4)
✅ 判定: 正常 (左上配置)
```

### 相対位置ベース実行例

```
📊 比較分析: 現在4個 vs 基準4個
     0度回転での一致スコア: 0.000
    90度回転での一致スコア: 0.808  ← 最高スコア
   180度回転での一致スコア: 0.187
   270度回転での一致スコア: 0.000
✅ 最適な回転角度: 90度 (スコア: 0.808)
🎯 -90度回転を適用して修正
```
